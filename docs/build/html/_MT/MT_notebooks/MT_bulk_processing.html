

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Processing MT data on the NCI &mdash; NCI training 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Convert MT time-series to netCDF example" href="ascii_to_netCDFb.html" />
    <link rel="prev" title="" href="../MT_data_examples.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> NCI training
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Data access, processing and manipulation examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../MT_data_examples.html">Magnetotellurics (MT) data</a></li>
</ul>
<p class="caption"><span class="caption-text">MT Jupyter notebooks</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Bulk time series processing at the NCI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Preparation">Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Putting-it-together">Putting it together</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Running-on-the-NCI">Running on the NCI</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ascii_to_netCDFb.html">Converting MT ASCII time series to NetCDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="MT_with_OPENDAPb.html">MT processing using OPeNDAP</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NCI training</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Processing MT data on the NCI</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/_MT/MT_notebooks/MT_bulk_processing.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="figure">
<img alt="" src="http://nci.org.au/wp-content/themes/nci/img/img-logo-large.png" />
</div>
<div class="section" id="Processing-MT-data-on-the-NCI">
<h1>Processing MT data on the NCI<a class="headerlink" href="#Processing-MT-data-on-the-NCI" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Requirements">
<h2>Requirements<a class="headerlink" href="#Requirements" title="Permalink to this headline">¶</a></h2>
<p>The following tutorial shows how to process magnetotelluric (MT) data
stored on the National Computational Infrastructure (NCI). As such it
makes certain assumptions about the storage structure, mainly that the
time series data are stored in separate folders for each site and
separate folders for each day. The tutorial uses the <a class="reference external" href="https://www.whoi.edu/science/AOPE/people/achave/Site/Next1.html">Bounded Influence,
Remote Reference Processing (BIRRP)
code.</a></p>
</div>
<div class="section" id="Preparation">
<h2>Preparation<a class="headerlink" href="#Preparation" title="Permalink to this headline">¶</a></h2>
<p>For this example we will be processing the <a class="reference external" href="http://dx.doi.org/10.25914/5bea5867bb322">Renmark 2009 time series
data</a> located on NCI’s
/g/data file system. The first step in processing is to work out the
starting and finishing dates for each site in the survey, in order to
find the sites with overlapping time-series which can be used for
remote-reference.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="k">def</span> <span class="nf">_linecount</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return number of lines in a file &quot;&quot;&quot;</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">num_lines</span>

<span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return information about each site &quot;&quot;&quot;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s1">&#39;metadata.json&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sites</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))]</span>

    <span class="n">sites</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span>
                       <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">last_files</span> <span class="o">=</span> <span class="n">files</span>
            <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span>
                                                        <span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
                <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">])</span>
        <span class="c1">#if not files:</span>
        <span class="c1">#    continue</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">last_files</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">_linecount</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">length</span><span class="o">/</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">-</span>
                                  <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">seconds</span> <span class="o">*</span> <span class="n">frequency</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sites</span>

</pre></div>
</div>
</div>
<p>This function will read in the metadata required for processing a
survey. After this processing it will write out this metadata into a
file, which will be read back in the next time that the metadata is
required.</p>
<p>We will also make a function to calculate the overlap between two sites:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">calc_intersection</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate time overlap of a local site and remote site &quot;&quot;&quot;</span>
    <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">],</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span>
    <span class="n">int_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">],</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">60</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span>
</pre></div>
</div>
</div>
<p>if the overlap is less than 5 hours then the function returns nothing,
indicating no substantial overlap, otherwise it will return the start
and end times of the intersection.</p>
<p>The next stage is to make functions for writing out the overlap between
the time series from two different sites as ASCII files for BIRRP use as
inputs. Here one of the sites is designated as the remote reference.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>

<span class="k">def</span> <span class="nf">decimate_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read in a time series, apply a decimation and write out &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_fn</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_fn</span><span class="p">):</span>
         <span class="k">return</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;decimating {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">new_fn</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">num_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write files &quot;&quot;&quot;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;local.&#39;</span> <span class="o">+</span> <span class="n">channel</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">remote</span> <span class="k">else</span> <span class="s1">&#39;remote.&#39;</span> <span class="o">+</span> <span class="n">channel</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">tstart</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fn</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">)):</span>
        <span class="k">return</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;writing to {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">)))</span>
    <span class="n">ofile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">ifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">num_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_skip</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">ifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># print(&#39;did not extract from {}&#39;.format(files))</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_birrp_inputs</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write out the intersection of two files &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calc_intersection</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">):</span>
        <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span> <span class="o">=</span> <span class="n">calc_intersection</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">)</span>
    <span class="n">local_skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_start</span> <span class="o">-</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">500</span>
    <span class="n">remote_skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_start</span> <span class="o">-</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">500</span>
    <span class="n">local_skip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">local_skip</span><span class="p">)</span>
    <span class="n">remote_skip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">remote_skip</span><span class="p">)</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
        <span class="n">remote_skip</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">num_samples</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">dec_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;undecimated&#39;</span><span class="p">)</span>
    <span class="n">dec10_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated10&#39;</span><span class="p">)</span>
    <span class="n">dec100_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated100&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dec_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dec10_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dec100_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BX&#39;</span><span class="p">,</span> <span class="s1">&#39;BY&#39;</span><span class="p">,</span> <span class="s1">&#39;EX&#39;</span><span class="p">,</span> <span class="s1">&#39;EY&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">write_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">local_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dec_dir</span><span class="p">,</span> <span class="n">int_start</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="s1">&#39;B&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">write_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">remote_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dec_dir</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span>
                    <span class="n">remote</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dec_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">):</span>
            <span class="n">bn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">new_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dec10_dir</span><span class="p">,</span> <span class="n">bn</span><span class="p">)</span>
            <span class="n">decimate_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">new_fn</span>
            <span class="n">new_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dec100_dir</span><span class="p">,</span> <span class="n">bn</span><span class="p">)</span>
            <span class="n">decimate_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">int_start</span>

</pre></div>
</div>
</div>
<p>Note that decimations are also performed, with the decimated time series
placed into new folders. By decimating the data we can achieve responses
for longer periods than would otherwise be possible. Decimation is made
using
<a class="reference external" href="https://docs.scipy.org/doc/scipy-1.1.0/reference/generated/scipy.signal.decimate.html">scipy.signal.decimate</a>,
which applies an anti-aliasing filter before decimating.</p>
<p>For each three of these folders we generate a BIRRP script:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">gen_birrp_script</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">site_name</span><span class="p">,</span> <span class="n">tstart</span><span class="p">):</span>
    <span class="n">birrp_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;{2}&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;65536,2,13&#39;</span><span class="p">,</span> <span class="s1">&#39;3,1,3&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0,0.0003,0.9999&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0&#39;</span><span class="p">,</span> <span class="s1">&#39;0.003,10000&#39;</span><span class="p">,</span> <span class="s1">&#39;{3}&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;{1}&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;{4}_local.EY&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;{4}_local.EX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;{4}_local.BY&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;{4}_local.BX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;{4}_remote.BY&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;{4}_remote.BX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0,90,0&#39;</span><span class="p">,</span> <span class="s1">&#39;0,90,0&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0,90,0&#39;</span><span class="p">])</span>
    <span class="n">birrp_string</span> <span class="o">=</span> <span class="n">birrp_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                       <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">site_name</span><span class="p">,</span>
                                       <span class="n">tstart</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">birrp_string</span>
</pre></div>
</div>
</div>
<p>The BIRRP script has many different parameters and the best parameters
will depend on the dataset. For more information see the <a class="reference external" href="http://www.whoi.edu/science/AOPE/people/achave/Site/Next1_files/birrp.5.pdf">BIRRP
manual</a>.</p>
<p>We also need a script to run BIRRP and to clean up the output files:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">run_birrp</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">birrp_script</span><span class="p">,</span> <span class="n">birrp_location</span><span class="p">):</span>
    <span class="n">script_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;script.txt&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">birrp_script</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.j&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)):</span>
        <span class="k">return</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mpirun -np 32 {} &lt; {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">birrp_location</span><span class="p">,</span> <span class="n">script_fn</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;fft.*&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;remote.*&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;local.*&#39;</span><span class="p">):</span>  <span class="c1">### comment this for loop if you want to keep the intermediate files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, we would like a script to convert the outputs from our three
frequency ranges into edi-files and to merge them into a single file.
The merging should take place at the longest overlapping period, as this
introduces the minimum amount of error resulting from aliasing during
the decimation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">mtpy.core.edi</span>
<span class="kn">from</span> <span class="nn">mtpy.uofa.qel_monitoring_j2edi</span> <span class="kn">import</span> <span class="n">convert2edi</span>
<span class="kn">from</span> <span class="nn">mtpy.uofa.simpleplotEDI</span> <span class="kn">import</span> <span class="n">plotedi</span>


<span class="k">def</span> <span class="nf">process_birrp_results</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="p">,</span> <span class="n">site_name</span><span class="p">,</span> <span class="n">instr_resp_fn</span><span class="p">):</span>
    <span class="n">edi</span><span class="p">,</span> <span class="n">coh</span> <span class="o">=</span> <span class="n">convert2edi</span><span class="p">(</span><span class="n">site_name</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="p">,</span> <span class="n">instr_resp_fn</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span>  <span class="n">mtpy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">configfile</span><span class="o">.</span><span class="n">read_survey_configfile</span><span class="p">(</span><span class="n">survey_cfg_fn</span><span class="p">)[</span><span class="n">site_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">Edi</span><span class="p">(</span><span class="n">edi</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;loc&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s1">&#39;acqdate&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;acqdate&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s1">&#39;acquired_by&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqby&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;acquired_by&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqby&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">edi</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">writefile</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">allow_overwrite</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">edi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;qel&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">edi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">edi</span><span class="p">)</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="n">edi_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">new_edi_name</span> <span class="o">=</span> <span class="n">new_name</span> <span class="o">+</span> <span class="s1">&#39;.edi&#39;</span>
    <span class="n">new_coh_name</span> <span class="o">=</span> <span class="n">new_name</span> <span class="o">+</span> <span class="s1">&#39;.coh&#39;</span>
    <span class="n">new_edi</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">new_edi_name</span>
    <span class="n">coh_orig</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">coh</span>
    <span class="n">new_coh</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">new_coh_name</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">new_edi</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">coh_orig</span><span class="p">,</span> <span class="n">new_coh</span><span class="p">)</span>
    <span class="c1"># edi = glob(os.path.join(out_dir, &#39;*.edi&#39;))[0]</span>
    <span class="n">plotedi</span><span class="p">(</span><span class="n">new_edi</span><span class="p">,</span> <span class="n">saveplot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">merge_birrp_results</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">site_name</span><span class="p">):</span>
    <span class="n">edi_fns</span> <span class="o">=</span> <span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;undecimated&#39;</span><span class="p">,</span> <span class="s1">&#39;*edi&#39;</span><span class="p">))</span> <span class="o">+</span>
               <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated10&#39;</span><span class="p">,</span> <span class="s1">&#39;*edi&#39;</span><span class="p">))</span> <span class="o">+</span>
               <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated100&#39;</span><span class="p">,</span> <span class="s1">&#39;*edi&#39;</span><span class="p">)))</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">Edi</span><span class="p">(</span><span class="n">edi_fns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">Edi</span><span class="p">(</span><span class="n">edi_fns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">out_small</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">combine_edifiles</span><span class="p">(</span><span class="n">edi_fns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edi_fns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_fn</span><span class="o">=</span><span class="n">out_small</span><span class="p">,</span>
                                   <span class="n">merge_freq</span><span class="o">=</span><span class="n">e1</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">out_large</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">site_name</span><span class="p">)</span>
    <span class="n">in_small</span> <span class="o">=</span> <span class="n">out_small</span> <span class="o">+</span> <span class="s1">&#39;_merged.edi&#39;</span>
    <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">combine_edifiles</span><span class="p">(</span><span class="n">in_small</span><span class="p">,</span> <span class="n">edi_fns</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out_fn</span><span class="o">=</span><span class="n">out_large</span><span class="p">,</span>
                                   <span class="n">merge_freq</span><span class="o">=</span><span class="n">e2</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">in_small</span><span class="p">)</span>
    <span class="n">final_fn</span> <span class="o">=</span> <span class="n">out_large</span> <span class="o">+</span> <span class="s1">&#39;_merged.edi&#39;</span>
    <span class="n">plotedi</span><span class="p">(</span><span class="n">final_fn</span><span class="p">,</span> <span class="n">saveplot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Each EDI generated is also plotted. This code makes use of the <code class="docutils literal notranslate"><span class="pre">mtpy</span></code>
<a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0098300414001794">(Krieger and Peacock,
2014)</a>
library.</p>
<p>Note that this script requires both a instrument response function file,
and a survey configuration filename. Details on the survey configuration
file can be found in the <code class="docutils literal notranslate"><span class="pre">mtpy</span></code> package, however it will looks
something like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="p">[</span><span class="n">RM0105</span><span class="p">]</span>
<span class="n">station_type</span> <span class="o">=</span> <span class="n">mt</span>
<span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">34.05543333333333</span>
<span class="n">lon</span> <span class="o">=</span> <span class="mf">140.62353333333334</span>
<span class="n">elev</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sampling</span> <span class="o">=</span> <span class="mf">0.002</span>
<span class="n">loc</span> <span class="o">=</span> <span class="n">Renmark</span>
<span class="n">acqdate</span> <span class="o">=</span> <span class="mi">2009</span>
<span class="n">acquired_by</span> <span class="o">=</span> <span class="n">The_University_of_Adelaide</span>


<span class="p">[</span><span class="n">RM0106</span><span class="p">]</span>
<span class="n">station_type</span> <span class="o">=</span> <span class="n">mt</span>
<span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">34.041183333333336</span>
<span class="n">lon</span> <span class="o">=</span> <span class="mf">140.60265</span>
<span class="n">elev</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sampling</span> <span class="o">=</span> <span class="mf">0.002</span>
<span class="n">loc</span> <span class="o">=</span> <span class="n">Renmark</span>
<span class="n">acqdate</span> <span class="o">=</span> <span class="mi">2009</span>
<span class="n">acquired_by</span> <span class="o">=</span> <span class="n">The_University_of_Adelaide</span>

<span class="c1">#[RM0107]</span>
<span class="c1">#station_type = mt</span>
<span class="c1">#lat = -34.004266666666666</span>
<span class="c1">#lon = 140.5869</span>
<span class="c1">#elev = 0</span>
<span class="c1">#sampling = 0.002</span>
<span class="c1">#loc = Renmark</span>
<span class="c1">#acqdate = 2009</span>
<span class="c1">#acquired_by = The_University_of_Adelaide</span>
</pre></div>
</div>
</div>
<p>And so on, for each site.</p>
</div>
<div class="section" id="Putting-it-together">
<h2>Putting it together<a class="headerlink" href="#Putting-it-together" title="Permalink to this headline">¶</a></h2>
<p>These functions can be wrapped into one function to process a single
site with a single remote site:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">run_one_site</span><span class="p">(</span><span class="n">local_name</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;undecimated&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span> <span class="s1">&#39;decimated10&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;decimated100&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;base_dir&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">],</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;got metadata&#39;</span><span class="p">)</span>
    <span class="n">local_site</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="n">local_name</span><span class="p">]</span>
    <span class="n">remote_site</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="n">remote_name</span><span class="p">]</span>
    <span class="n">dir_name</span> <span class="o">=</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">samples</span><span class="p">,</span> <span class="n">tstart</span> <span class="o">=</span> <span class="n">write_birrp_inputs</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;written inputs&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">dirs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">dirs</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span>
        <span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
        <span class="n">birrp_script</span> <span class="o">=</span> <span class="n">gen_birrp_script</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span>
                                        <span class="n">local_name</span><span class="p">,</span> <span class="n">tstart</span><span class="p">)</span>
        <span class="n">run_birrp</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">birrp_script</span><span class="p">,</span> <span class="n">birrp_location</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;ran birrp&#39;</span><span class="p">)</span>
        <span class="n">process_birrp_results</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;survey_cfg_fn&#39;</span><span class="p">],</span>
                              <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instr_resp_fn&#39;</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;processed results&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
    <span class="n">merge_birrp_results</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">local_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If we save all of this to a file as <code class="docutils literal notranslate"><span class="pre">nci_birrp.py</span></code> we can create a
separate file in the same folder which calls it and runs one site:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python2.7</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">nci_birrp</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/States_and_Territories/SA/Broadband/Renmark_2009/TS&#39;</span>
    <span class="n">birrp_location</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/test/BIRRP_dev/birrp_NR_test/may_test/birrp_mpi&#39;</span>
    <span class="n">survey_cfg_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/test/test_renmark/renmark.cfg&#39;</span>
    <span class="n">instr_resp_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/instrument_response_files/lemi_coils_instrument_response_freq_real_imag.txt&#39;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instr_resp_fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instr_resp_fn</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;survey_cfg_fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey_cfg_fn</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;birrp_location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">birrp_location</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_dir</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">run_one_site</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can save this as <code class="docutils literal notranslate"><span class="pre">proc_site.py</span></code>.</p>
<p>Here we enter the parameters specific to our example. For our example we
use the Renmark 2009 MT dataset from the NCI, which is recorded at 500
Hz and has a configuration file located at
<code class="docutils literal notranslate"><span class="pre">/g/data/my80/test/test_renmark/renmark.cfg</span></code>.</p>
<p>The system arguments are site specific, with the local site name, remote
site name, and temporary working directory.</p>
<div class="section" id="Running-on-the-NCI">
<h3>Running on the NCI<a class="headerlink" href="#Running-on-the-NCI" title="Permalink to this headline">¶</a></h3>
<p>We are now almost ready to process the entire survey on the NCI. First
we will need a script to submit <code class="docutils literal notranslate"><span class="pre">proc_site.py</span></code> to process the data
from one site with a single remote site.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">add_shell_run</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">):</span>
    <span class="n">python_call</span> <span class="o">=</span> <span class="n">proc_site</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="n">shell_script</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;#!/bin/bash&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;#PBS -P z00&#39;</span><span class="p">,</span> <span class="s1">&#39;#PBS -q normal&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;#PBS -l walltime=10:00:00,mem=128GB,ncpus=32,jobfs=100GB&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;#PBS -l wd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;module load python/2.7.11&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;module load python/2.7.11-matplotlib&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;module use /g/data/my80/modulefiles/&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;module load mtpy_nci_processing/mtpy_0.0.1&#39;</span><span class="p">,</span><span class="s1">&#39;module load openmpi/3.1.3&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">python_call</span><span class="p">])</span>
    <span class="n">shell_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">local_site</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">remote_site</span> <span class="o">+</span> <span class="s1">&#39;.sh&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shell_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shell_script</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;qsub {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shell_fn</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>This function will submit the job to the NCI. Take care to choose
optimal values for the walltime and memory consumption, as these will
change depending on the recording length.</p>
<p>We can now loop over each combination of local and remote sites, check
to see if there is sufficient overlap, and if so, submit a job to the
NCI to process.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">mtpy.utils.configfile</span>

<span class="k">def</span> <span class="nf">loop_sites</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">survey_cfg_fn</span><span class="p">:</span>
        <span class="n">survey_cfg</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">configfile</span><span class="o">.</span><span class="n">read_survey_configfile</span><span class="p">(</span><span class="n">survey_cfg_fn</span><span class="p">)</span>
    <span class="n">site_names</span> <span class="o">=</span> <span class="n">sites</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">site_names</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">site</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">survey_cfg</span><span class="p">:</span>
            <span class="n">sites</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">local_site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">remote_site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">calc_intersection</span><span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">local_site</span><span class="p">],</span> <span class="n">sites</span><span class="p">[</span><span class="n">remote_site</span><span class="p">]):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;add {} and {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">))</span>
                <span class="n">add_shell_run</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
                <span class="c1">#sys.exit()  ####uncomment this line if you are troubleshooting</span>

</pre></div>
</div>
</div>
<p>An option is also included to pass a survey configuration file (as
detailed above), where you can comment out any sites which you do not
want to process.</p>
<p>Let’s write our <code class="docutils literal notranslate"><span class="pre">nci_birrp.py</span></code> and <code class="docutils literal notranslate"><span class="pre">proc_site.py</span></code> files to our local
working directory on Raijin:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">writefile</span> nci_birrp.py

# module load birrp
import pickle
import os
import datetime
from glob import glob
import numpy as np
import scipy.signal
import mtpy.core.edi
from mtpy.uofa.qel_monitoring_j2edi import convert2edi
from mtpy.uofa.simpleplotEDI import plotedi
import mtpy.utils.configfile
import shutil
import sys

#######################################################################
#                                                                     #
# Note that you will have to change the following variables to match  #
# the time series data location, birrp executable location, survey    #
# config file, instrument response function, temporary directory,     #
# recorded frequency and and proc_site.py file you are using          #
#                                                                     #
#######################################################################

base_dir = &#39;/g/data/my80/States_and_Territories/SA/Broadband/Renmark_2009/TS&#39;
birrp_location = &#39;/g/data/my80/test/BIRRP_dev/birrp_NR_test/may_test/birrp_mpi&#39;
survey_cfg_fn = &#39;/g/data/my80/test/test_renmark/renmark.cfg&#39;
instr_resp_fn = &#39;/g/data/my80/instrument_response_files/lemi_coils_instrument_response_freq_real_imag.txt&#39;
tmp_dir = &#39;/g/data/my80/test/test_renmark/bulk_processing_test/renmark_proc_b&#39;
frequency = 500
proc_site = &#39;/g/data3/my80/test/test_renmark/bulk_processing_test/proc_site_mpi.py {} {} {}&#39;

def _linecount(filename):
    &quot;&quot;&quot; Return number of lines in a file &quot;&quot;&quot;
    num_lines = sum(1 for line in open(filename))
    return num_lines


def get_metadata(base_dir, frequency, tmp_dir):
    &quot;&quot;&quot; Return information about each site &quot;&quot;&quot;
    fn = os.path.join(tmp_dir, &#39;metadata.json&#39;)
    if os.path.exists(fn):
        with open(fn) as f:
            sites = pickle.load(f)
        return sites
    sites = [os.path.basename(i) for i in glob(os.path.join(base_dir, &#39;*&#39;))]

    sites = dict([(i, {}) for i in sites])

    for site in sites.keys():
        sites[site][&#39;name&#39;] = site
        sites[site][&#39;files&#39;] = []
        days = sorted([os.path.basename(i) for
                       i in glob(os.path.join(base_dir, site, &#39;*&#39;))])
        for idx, day in enumerate(days):
            files = glob(os.path.join(base_dir, site, day, &#39;*&#39;))
            if not files:
                continue
            last_files = files
            sites[site][&#39;files&#39;].append(files)
            if idx == 0:
                start_time = os.path.basename(files[0]).split(&#39;_&#39;)[1].split(&#39;.&#39;)[0]
                start_time = datetime.datetime.strptime(start_time,
                                                        &#39;%y%m%d%H%M%S&#39;)
                sites[site][&#39;start_time&#39;] = start_time
        if not [j for k in sites[site][&#39;files&#39;] for j in k]:
            del sites[site]
            continue
        sites[site][&#39;files&#39;] = [j for k in sites[site][&#39;files&#39;] for j in k]
        print(site, sites[site][&#39;files&#39;])
        #if not files:
        #    continue
        files = last_files
        end_date = os.path.basename(files[0]).split(&#39;_&#39;)[1].split(&#39;.&#39;)[0]
                end_date = datetime.datetime.strptime(end_date, &#39;%y%m%d%H%M%S&#39;)
        length = _linecount(files[0])
        end_time = end_date + datetime.timedelta(seconds=length/frequency)
        sites[site][&#39;end_time&#39;] = end_time
        sites[site][&#39;samples&#39;] = (sites[site][&#39;end_time&#39;] -
                                  sites[site][&#39;start_time&#39;]).seconds * frequency

    with open(fn, &#39;w&#39;) as f:
        pickle.dump(sites, f)
    return sites


def calc_intersection(local_site, remote_site):
    &quot;&quot;&quot; Calculate time overlap of a local site and remote site &quot;&quot;&quot;
    int_start = max(local_site[&#39;start_time&#39;], remote_site[&#39;start_time&#39;])
    int_end = min(local_site[&#39;end_time&#39;], remote_site[&#39;end_time&#39;])
    if (int_end - int_start).total_seconds()/60/60 &lt; 5:
        return
    else:
        return int_start, int_end


def decimate_file(fn, decimation, new_fn):
    &quot;&quot;&quot; Read in a time series, apply a decimation and write out &quot;&quot;&quot;
    print(fn, decimation, new_fn)
    print(os.path.exists(new_fn))
    if os.path.exists(new_fn):
         return
    print(&#39;decimating {}&#39;.format(fn))
    f = np.genfromtxt(fn)
    f = scipy.signal.decimate(f, decimation, n=8)
    np.savetxt(new_fn, f)


def write_files(files, num_skip, num_samples, channel, out_dir, tstart, remote=False):
    &quot;&quot;&quot; Write files &quot;&quot;&quot;
    fn = &#39;local.&#39; + channel if not remote else &#39;remote.&#39; + channel
    fn = tstart.strftime(&#39;%y%m%d%H%M%S&#39;) + &#39;_&#39; + fn
    if os.path.exists(os.path.join(out_dir, fn)):
        return
    print(&#39;writing to {}&#39;.format(os.path.join(out_dir, fn)))
    ofile = open(os.path.join(out_dir, fn), &#39;w&#39;)
    ifile = open(files.pop(0))
    print(files, num_skip, num_samples)
    for _ in range(num_skip):
        try:
            next(ifile)
        except StopIteration:
            ifile = open(files.pop(0))
    for _ in range(num_samples):
        try:
            line = next(ifile)
        except StopIteration:
            try:
                ifile = open(files.pop(0))
            except IndexError:
                pass
                # print(&#39;did not extract from {}&#39;.format(files))
        ofile.write(line)



def write_birrp_inputs(local_site, remote_site, out_dir):
    &quot;&quot;&quot; Write out the intersection of two files &quot;&quot;&quot;
    if calc_intersection(local_site, remote_site):
        int_start, int_end = calc_intersection(local_site, remote_site)
    local_skip = (int_start - local_site[&#39;start_time&#39;]).total_seconds()*500
    remote_skip = (int_start - remote_site[&#39;start_time&#39;]).total_seconds()*500
    local_skip = int(local_skip)
    remote_skip = int(remote_skip)
    num_samples = int((int_end - int_start).total_seconds()*500)
    if local_site[&#39;name&#39;] == remote_site[&#39;name&#39;]:
        remote_skip += 1
        num_samples -= 1
    dec_dir = os.path.join(out_dir, &#39;undecimated&#39;)
    dec10_dir = os.path.join(out_dir, &#39;decimated10&#39;)
    dec100_dir = os.path.join(out_dir, &#39;decimated100&#39;)
    try:
        os.makedirs(dec_dir)
    except OSError:
        pass
    try:
        os.makedirs(dec10_dir)
    except OSError:
        pass
    try:
        os.makedirs(dec100_dir)
    except OSError:
        pass
    channels = [&#39;BX&#39;, &#39;BY&#39;, &#39;EX&#39;, &#39;EY&#39;]
    for channel in channels:
        files = sorted([i for i in local_site[&#39;files&#39;] if channel in i])
        write_files(files, local_skip, num_samples, channel, dec_dir, int_start)
    for channel in [i for i in channels if &#39;B&#39; in i]:
        files = sorted([i for i in remote_site[&#39;files&#39;] if channel in i])
        write_files(files, remote_skip, num_samples, channel, dec_dir, int_start,
                    remote=True)
    for fn in glob(os.path.join(dec_dir, &#39;*&#39;)):
        if fn.endswith(&#39;X&#39;) or fn.endswith(&#39;Y&#39;):
            bn = os.path.basename(fn)
            new_fn = os.path.join(dec10_dir, bn)
            decimate_file(fn, 10, new_fn)
            fn = new_fn
            new_fn = os.path.join(dec100_dir, bn)
            decimate_file(fn, 10, new_fn)
    return num_samples, int_start


def gen_birrp_script(out_dir, samples, sample_rate, site_name, tstart):
    birrp_string = &#39;\n&#39;.join([&#39;1&#39;, &#39;2&#39;, &#39;2&#39;, &#39;2&#39;, &#39;1&#39;, &#39;3&#39;, &#39;{2}&#39;,
                              &#39;65536,2,13&#39;, &#39;3,1,3&#39;, &#39;y&#39;, &#39;2&#39;,
                              &#39;0,0.0003,0.9999&#39;, &#39;0.7&#39;, &#39;0.0&#39;, &#39;0.003,10000&#39;, &#39;{3}&#39;, &#39;0&#39;, &#39;0&#39;,
                              &#39;1&#39;, &#39;10&#39;, &#39;0&#39;, &#39;0&#39;, &#39;{1}&#39;, &#39;0&#39;, &#39;{4}_local.EY&#39;,
                              &#39;0&#39;, &#39;0&#39;, &#39;{4}_local.EX&#39;, &#39;0&#39;, &#39;0&#39;, &#39;{4}_local.BY&#39;,
                              &#39;0&#39;, &#39;0&#39;, &#39;{4}_local.BX&#39;, &#39;0&#39;, &#39;0&#39;, &#39;{4}_remote.BY&#39;,
                              &#39;0&#39;, &#39;0&#39;, &#39;{4}_remote.BX&#39;, &#39;0&#39;, &#39;0,90,0&#39;, &#39;0,90,0&#39;,
                              &#39;0,90,0&#39;])
    birrp_string = birrp_string.format(os.path.join(out_dir, &#39;&#39;),
                                       samples, sample_rate, site_name,
                                       tstart.strftime(&#39;%y%m%d%H%M%S&#39;))
    return birrp_string

def run_birrp(out_dir, birrp_script, birrp_location):
    script_fn = os.path.join(out_dir, &#39;script.txt&#39;)
    with open(script_fn, &#39;w&#39;) as f:
        f.write(birrp_script)
    if any(fn.endswith(&#39;.j&#39;) for fn in os.listdir(out_dir)):
        return
    os.system(&#39;{} &lt; {}&#39;.format(birrp_location, script_fn))
    for f in glob(&#39;fft.*&#39;):
        os.remove(f)
    #for f in glob(&#39;remote.*&#39;) + glob(&#39;local.*&#39;):  ###uncomment this for loop if you want to remove the intermediate files
    #    #os.remove(f)


def process_birrp_results(out_dir, survey_cfg_fn, site_name, instr_resp_fn):
    edi, coh = convert2edi(site_name, out_dir, survey_cfg_fn, instr_resp_fn, None)
    metadata =  mtpy.utils.configfile.read_survey_configfile(survey_cfg_fn)[site_name.upper()]
    e = mtpy.core.edi.Edi(edi)
    if &#39;loc&#39; in metadata:
        e.head[&#39;loc&#39;] = metadata[&#39;loc&#39;]
    else:
        e.head[&#39;loc&#39;] = None
    if &#39;acqdate&#39; in metadata:
        e.head[&#39;acqdate&#39;] = metadata[&#39;acqdate&#39;]
    else:
        e.head[&#39;acqdate&#39;] = None
    if &#39;acquired_by&#39; in metadata:
        e.head[&#39;acqby&#39;] = metadata[&#39;acquired_by&#39;]
    else:
        e.head[&#39;acqby&#39;] = &#39;&#39;
    edi = e.writefile(edi, allow_overwrite=True)
    path = edi.split(&quot;qel&quot;)[0]
    edi_file = os.path.basename(edi)
    new_name = edi_file.split(&quot;_&quot;)[1]
    new_edi_name = new_name + &#39;.edi&#39;
    new_coh_name = new_name + &#39;.coh&#39;
    new_edi = path + new_edi_name
    coh_orig = path + coh
    new_coh = path + new_coh_name
    shutil.move(edi, new_edi)
    shutil.move(coh_orig, new_coh)
    # edi = glob(os.path.join(out_dir, &#39;*.edi&#39;))[0]
    plotedi(new_edi, saveplot=True)
    return

def merge_birrp_results(out_dir, site_name):
    edi_fns = (glob(os.path.join(out_dir, &#39;undecimated&#39;, &#39;*edi&#39;)) +
               glob(os.path.join(out_dir, &#39;decimated10&#39;, &#39;*edi&#39;)) +
               glob(os.path.join(out_dir, &#39;decimated100&#39;, &#39;*edi&#39;)))
    e1 = mtpy.core.edi.Edi(edi_fns[0])
    e2 = mtpy.core.edi.Edi(edi_fns[1])
    out_small = os.path.join(out_dir, &#39;small&#39;)
    mtpy.core.edi.combine_edifiles(edi_fns[0], edi_fns[1], out_fn=out_small,
                                   merge_freq=e1.freq[-2])
    out_large = os.path.join(out_dir, site_name)
    in_small = out_small + &#39;_merged.edi&#39;
    mtpy.core.edi.combine_edifiles(in_small, edi_fns[2], out_fn=out_large,
                                   merge_freq=e2.freq[-2])
    os.remove(in_small)
    final_fn = out_large + &#39;_merged.edi&#39;
    plotedi(final_fn, saveplot=True)


def run_one_site(local_name, remote_name, tmp_dir, **kwargs):
    dirs = {&#39;undecimated&#39;: 0.002, &#39;decimated10&#39;: 0.02, &#39;decimated100&#39;: 0.2}
    sites = get_metadata(kwargs[&#39;base_dir&#39;], kwargs[&#39;frequency&#39;], tmp_dir)
    print(&#39;got metadata&#39;)
    local_site = sites[local_name]
    remote_site = sites[remote_name]
    dir_name = local_site[&#39;name&#39;] + remote_site[&#39;name&#39;]
    out_dir = os.path.join(tmp_dir, dir_name)
    try:
        os.makedirs(out_dir)
    except OSError:
        pass
    cwd = os.getcwd()
    samples, tstart = write_birrp_inputs(local_site, remote_site, out_dir)
    print(&#39;written inputs&#39;)
    for dir_name in dirs.keys():
        sample_rate = dirs[dir_name]
        dir_name = os.path.join(out_dir, dir_name)
        os.chdir(dir_name)
        birrp_script = gen_birrp_script(dir_name, samples, sample_rate,
                                        local_name, tstart)
        run_birrp(dir_name, birrp_script, birrp_location)
        print(&#39;ran birrp&#39;)
        process_birrp_results(dir_name, kwargs[&#39;survey_cfg_fn&#39;],
                              local_site[&#39;name&#39;], kwargs[&#39;instr_resp_fn&#39;])
        print(&#39;processed results&#39;)
        os.chdir(cwd)
    merge_birrp_results(out_dir, local_name)

def add_shell_run(local_site, remote_site, base_dir, tmp_dir):
    python_call = proc_site.format(local_site, remote_site, tmp_dir)
    shell_script = &#39;\n&#39;.join([&#39;#!/bin/bash&#39;, &#39;&#39;, &#39;#PBS -P z00&#39;, &#39;#PBS -q normal&#39;,
                            &#39;#PBS -l walltime=10:00:00,mem=128GB,ncpus=32,jobfs=100GB&#39;,
                            &#39;#PBS -l wd&#39;, &#39;&#39;, &#39;module load python/2.7.11&#39;,
                            &#39;module load python/2.7.11-matplotlib&#39;,
                            &#39;module use /g/data/my80/modulefiles/&#39;,
                            &#39;module load mtpy_nci_processing/mtpy_0.0.1&#39;,&#39;module load openmpi/3.1.3&#39;, &#39;&#39;, python_call])
    shell_fn = os.path.join(tmp_dir, local_site + &#39;_&#39; + remote_site + &#39;.sh&#39;)
    with open(shell_fn, &#39;w&#39;) as f:
        f.write(shell_script)
    os.system(&#39;qsub {}&#39;.format(shell_fn))


def loop_sites(base_dir, tmp_dir, survey_cfg_fn=None):
    sites = get_metadata(base_dir, 500, tmp_dir)
    if survey_cfg_fn:
        survey_cfg = mtpy.utils.configfile.read_survey_configfile(survey_cfg_fn)
    site_names = sites.keys()
    for site in site_names:
       if site not in survey_cfg:
            sites.pop(site, None)
    print(sites)
    for local_site in sites:
        for remote_site in sites:
            if calc_intersection(sites[local_site], sites[remote_site]):
                print(&#39;add {} and {}&#39;.format(local_site, remote_site))
                add_shell_run(local_site, remote_site, base_dir, tmp_dir)
                #sys.exit()  ####uncomment line if you are troubleshooting


</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">writefile</span> proc_site.py

#!/usr/bin/env python2.7

import sys
from nci_birrp import *

if __name__ == &#39;__main__&#39;:
    kwargs = {}
    base_dir = &#39;/g/data/my80/test/test_renmark/TS&#39;
    birrp_location = &#39;/g/data/my80/test/BIRRP_dev/birrp_dennis/birrp_comp/birrp&#39;
    survey_cfg_fn = &#39;/g/data/my80/test/test_renmark/renmark.cfg&#39;
    instr_resp_fn = &#39;/g/data/my80/instrument_response_files/lemi_coils_instrument_response_freq_real_imag.txt&#39;
    kwargs[&#39;instr_resp_fn&#39;] = instr_resp_fn
    kwargs[&#39;survey_cfg_fn&#39;] = survey_cfg_fn
    kwargs[&#39;birrp_location&#39;] = birrp_location
    kwargs[&#39;base_dir&#39;] = base_dir
    kwargs[&#39;frequency&#39;] = 500
    run_one_site(sys.argv[1], sys.argv[2], sys.argv[3], **kwargs)

</pre></div>
</div>
</div>
<p>Note that for our example, we are using an MPI parallelised version of
BIRRP. Now let’s log onto Raijin and change into our working directory
where the <code class="docutils literal notranslate"><span class="pre">nci_birrp.py</span></code> and <code class="docutils literal notranslate"><span class="pre">proc_sites.py</span></code> files are located. Next
we need to run the following commands to set up our local environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ module purge

$ module load pbs

$ module load python/2.7.11

$ module use /g/data/my80/modulefiles

$ module load mtpy_2013/1.0

$ module load openmpi/3.1.3
</pre></div>
</div>
<p>To process the entire Renmark MT survey we would need, for example, open
up an IPython terminal and execute the following commands:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">run</span> nci_birrp.py

<span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/States_and_Territories/SA/Broadband/Renmark_2009/TS/&#39;</span>
<span class="n">birrp_location</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/test/BIRRP_dev/birrp_NR_test/may_test/birrp_mpi&#39;</span>
<span class="n">survey_cfg_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/test/test_renmark/renmark.cfg&#39;</span>
<span class="n">loop_sites</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can view the progress of the jobs in their queue by running
<code class="docutils literal notranslate"><span class="pre">qstat</span> <span class="pre">-x</span></code> in a bash terminal:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre>
<span></span>%%bash
qstat -x
</pre></div>
</div>
</div>
<p>After the jobs have executed on the NCI, the processed EDIs and plots
would be found in your tmp_dir, which for this example was
<code class="docutils literal notranslate"><span class="pre">/g/data/my80/test/test_renmark/bulk_processing_test/renmark_proc_mpi</span></code>.</p>
<p>If the processing fails, the cause can be debugged using the error file
created during running the job. These are located in the same directory
as the jobs are submitted (in our case the directory in which this
script is run).</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ascii_to_netCDFb.html" class="btn btn-neutral float-right" title="Convert MT time-series to netCDF example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../MT_data_examples.html" class="btn btn-neutral" title="" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, NCI.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>